{% extends 'procurement/base.html' %}

{% block title %}Purchase Orders - Procurement{% endblock %}
{% block page_title %}Purchase Orders{% endblock %}

{% block content %}
<div class="card">
    <!-- Header with Actions -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h2 class="card-title">
            <i class="fas fa-file-invoice"></i>
            Purchase Orders
        </h2>
        <div class="action-links">
            <a href="{% url 'procurement:purchase_order_create' %}" class="btn btn-success">
                <i class="fas fa-plus-circle"></i> New Purchase Order
            </a>
        </div>
    </div>

    <!-- Simple Filters -->
    <div class="card" style="margin-bottom: 25px;">
        <h3 style="color: var(--dark); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-filter" style="color: var(--primary);"></i>
            Filter Orders
        </h3>
        <form method="GET" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end;">
            <div class="form-group">
                <label for="status">Status</label>
                <select name="status" id="status" class="form-control" onchange="this.form.submit()">
                    <option value="">All Statuses</option>
                    {% for value, label in status_choices %}
                    <option value="{{ value }}" {% if request.GET.status == value %}selected{% endif %}>
                        {{ label }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="search">Search</label>
                <input type="text" name="search" id="search" class="form-control" 
                       placeholder="PO number or supplier" 
                       value="{{ request.GET.search|default:'' }}">
            </div>
            <div class="form-group">
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-filter"></i> Apply
                </button>
            </div>
            {% if request.GET.status or request.GET.search %}
            <div class="form-group">
                <a href="{% url 'procurement:purchase_order_list' %}" class="btn btn-secondary" style="width: 100%;">
                    <i class="fas fa-times"></i> Clear
                </a>
            </div>
            {% endif %}
        </form>
    </div>

    <!-- Purchase Orders Table -->
    <div class="table-responsive">
        <table>
            <thead>
                <tr>
                    <th>PO Number</th>
                    <th>Supplier</th>
                    <th>Requested By</th>
                    <th>Department</th>
                    <th>Status</th>
                    <th>Total Amount</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for po in purchase_orders %}
                <tr>
                    <td><strong>{{ po.po_number|default:"-" }}</strong></td>
                    <td>{{ po.supplier.name }}</td>
                    <td>{{ po.requested_by.full_name|default:"-" }}</td>
                    <td>{{ po.department|default:"-" }}</td>
                    <td>
                        <span class="status-badge status-{{ po.status|lower }}">{{ po.status }}</span>
                    </td>
                    <td><strong style="color: var(--success);">${{ po.total_amount|floatformat:2 }}</strong></td>
                    <td>{{ po.order_date|date:"M d, Y" }}</td>
                    <td>
                        <div class="action-links">
                            <a href="{% url 'procurement:purchase_order_detail' po.pk %}" class="action-btn info">
                                <i class="fas fa-eye"></i>
                            </a>
                            
                            {% if po.status == 'Draft' or po.status == 'Pending' %}
                            <a href="{% url 'procurement:purchase_order_update' po.pk %}" class="action-btn primary">
                                <i class="fas fa-edit"></i>
                            </a>
                            {% endif %}
                            
                            {% if po.status == 'Pending' %}
                            <a href="{% url 'procurement:purchase_order_approve' po.pk %}" class="action-btn success">
                                <i class="fas fa-check"></i>
                            </a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8">
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <p>No purchase orders found</p>
                            <a href="{% url 'procurement:purchase_order_create' %}" class="btn btn-success" style="margin-top: 15px;">
                                Create First PO
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Simple Pagination -->
    {% if purchase_orders.has_other_pages %}
    <div class="pagination">
        {% if purchase_orders.has_previous %}
            <a href="?page=1{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">&laquo;</a>
            <a href="?page={{ purchase_orders.previous_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">&lt;</a>
        {% endif %}
        
        <span class="current">Page {{ purchase_orders.number }} of {{ purchase_orders.paginator.num_pages }}</span>
        
        {% if purchase_orders.has_next %}
            <a href="?page={{ purchase_orders.next_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">&gt;</a>
            <a href="?page={{ purchase_orders.paginator.num_pages }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">&raquo;</a>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Simple Stats -->
    <div style="margin-top: 30px; padding: 15px; background: var(--light); border-radius: 10px; display: flex; justify-content: space-around; flex-wrap: wrap; gap: 15px;">
        <div style="text-align: center;">
            <div style="color: var(--primary); font-size: 1.2em; font-weight: 700;">
                {{ purchase_orders.paginator.count }}
            </div>
            <div style="color: var(--gray); font-size: 0.8em;">Total</div>
        </div>
        <div style="text-align: center;">
            <div style="color: var(--success); font-size: 1.2em; font-weight: 700;">
                {% with approved=0 %}
                    {% for po in purchase_orders %}
                        {% if po.status == 'Approved' %}
                            {% with approved=approved|add:1 %}{% endwith %}
                        {% endif %}
                    {% endfor %}
                    {{ approved }}
                {% endwith %}
            </div>
            <div style="color: var(--gray); font-size: 0.8em;">Approved</div>
        </div>
        <div style="text-align: center;">
            <div style="color: var(--warning); font-size: 1.2em; font-weight: 700;">
                {% with pending=0 %}
                    {% for po in purchase_orders %}
                        {% if po.status == 'Pending' %}
                            {% with pending=pending|add:1 %}{% endwith %}
                        {% endif %}
                    {% endfor %}
                    {{ pending }}
                {% endwith %}
            </div>
            <div style="color: var(--gray); font-size: 0.8em;">Pending</div>
        </div>
        <div style="text-align: center;">
            <div style="color: var(--info); font-size: 1.2em; font-weight: 700;">
                {% with total=0 %}
                    {% for po in purchase_orders %}
                        {% with total=total|add:po.total_amount %}{% endwith %}
                    {% endfor %}
                    ${{ total|floatformat:2 }}
                {% endwith %}
            </div>
            <div style="color: var(--gray); font-size: 0.8em;">Total Value</div>
        </div>
    </div>
</div>
{% endblock %}