{% extends 'procurement/base.html' %}

{% block title %}{% if editing %}Edit{% else %}Create New{% endif %} Purchase Order{% endblock %}
{% block page_title %}{% if editing %}Edit Purchase Order{% else %}Create New Purchase Order{% endif %}{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h2 class="card-title">
            <i class="fas fa-{% if editing %}edit{% else %}plus-circle{% endif %}"></i>
            {% if editing %}Edit Purchase Order{% else %}Create New Purchase Order{% endif %}
        </h2>
        <div class="action-links">
            <a href="{% if purchase_order %}{% url 'procurement:purchase_order_detail' purchase_order.pk %}{% else %}{% url 'procurement:purchase_order_list' %}{% endif %}" 
               class="action-btn info">
                <i class="fas fa-arrow-left"></i> Cancel
            </a>
        </div>
    </div>

    <form method="POST" id="purchaseOrderForm">
        {% csrf_token %}
        {{ formset.management_form }}
        
        <!-- Basic Information Section -->
        <div class="card" style="margin-bottom: 25px;">
            <h3 class="card-title" style="font-size: 1.2em; margin-bottom: 20px;">
                <i class="fas fa-info-circle"></i> Basic Information
            </h3>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="id_supplier">
                        <i class="fas fa-building"></i> Supplier *
                    </label>
                    {{ form.supplier }}
                    {% if form.supplier.errors %}
                    <div class="error-message" style="color: var(--danger); font-size: 0.85em; margin-top: 5px;">
                        {{ form.supplier.errors }}
                    </div>
                    {% endif %}
                </div>
                <div class="form-group">
                    <label for="id_requested_by">
                        <i class="fas fa-user-tie"></i> Requested By *
                    </label>
                    {{ form.requested_by }}
                    {% if form.requested_by.errors %}
                    <div class="error-message" style="color: var(--danger); font-size: 0.85em; margin-top: 5px;">
                        {{ form.requested_by.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="id_expected_delivery">
                        <i class="fas fa-calendar-alt"></i> Expected Delivery
                    </label>
                    {{ form.expected_delivery }}
                </div>
                <div class="form-group">
                    <label for="id_department">
                        <i class="fas fa-building"></i> Department *
                    </label>
                    {{ form.department }}
                    {% if form.department.errors %}
                    <div class="error-message" style="color: var(--danger); font-size: 0.85em; margin-top: 5px;">
                        {{ form.department.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="id_cost_center">
                        <i class="fas fa-money-bill-wave"></i> Cost Center
                    </label>
                    {{ form.cost_center }}
                </div>
                <div class="form-group">
                    <label for="id_budget_code">
                        <i class="fas fa-hashtag"></i> Budget Code
                    </label>
                    {{ form.budget_code }}
                </div>
            </div>
            
            <div class="form-group">
                <label for="id_notes">
                    <i class="fas fa-sticky-note"></i> Notes
                </label>
                {{ form.notes }}
            </div>
        </div>
        
        <!-- Items Section -->
        <div class="card" style="margin-bottom: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 class="card-title" style="font-size: 1.2em; margin: 0;">
                    <i class="fas fa-boxes"></i> Items Ordered
                </h3>
                <button type="button" id="addItemBtn" class="action-btn success">
                    <i class="fas fa-plus"></i> Add Item
                </button>
            </div>
            
            <div class="table-responsive">
                <table id="itemsTable">
                    <thead>
                        <tr>
                            <th>Item *</th>
                            <th>Quantity *</th>
                            <th>Unit Price *</th>
                            <th>Total</th>
                            <th style="width: 100px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="itemsTableBody">
                        {% for item_form in formset %}
                        <tr class="item-row">
                            <td>
                                {{ item_form.item }}
                                {% if item_form.item.errors %}
                                <div class="error-message" style="color: var(--danger); font-size: 0.85em; margin-top: 5px;">
                                    {{ item_form.item.errors }}
                                </div>
                                {% endif %}
                            </td>
                            <td>
                                {{ item_form.quantity }}
                                {% if item_form.quantity.errors %}
                                <div class="error-message" style="color: var(--danger); font-size: 0.85em; margin-top: 5px;">
                                    {{ item_form.quantity.errors }}
                                </div>
                                {% endif %}
                            </td>
                            <td>
                                {{ item_form.unit_price }}
                                {% if item_form.unit_price.errors %}
                                <div class="error-message" style="color: var(--danger); font-size: 0.85em; margin-top: 5px;">
                                    {{ item_form.unit_price.errors }}
                                </div>
                                {% endif %}
                            </td>
                            <td>
                                <span class="item-total" style="font-weight: 600; color: var(--success);">$0.00</span>
                            </td>
                            <td>
                                {% if item_form.DELETE %}
                                <label class="checkbox-container" style="display: flex; align-items: center; gap: 5px;">
                                    {{ item_form.DELETE }} 
                                    <span style="color: var(--danger); cursor: pointer;">
                                        <i class="fas fa-trash"></i> Remove
                                    </span>
                                </label>
                                {% else %}
                                <button type="button" class="remove-item-btn" style="color: var(--danger); background: none; border: none; cursor: pointer;">
                                    <i class="fas fa-trash"></i> Remove
                                </button>
                                {% endif %}
                                {{ item_form.id }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr style="background: linear-gradient(135deg, var(--light), #e2e8f0);">
                            <td colspan="3" style="text-align: right; padding: 15px; font-weight: 700; color: var(--dark);">
                                GRAND TOTAL:
                            </td>
                            <td colspan="2" style="padding: 15px;">
                                <span id="grandTotal" style="font-size: 1.3em; font-weight: 800; color: var(--success);">$0.00</span>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
            {% if formset.non_form_errors %}
            <div class="error-message" style="color: var(--danger); padding: 15px; background: #fee2e2; border-radius: 8px; margin-top: 15px;">
                {% for error in formset.non_form_errors %}
                {{ error }}
                {% endfor %}
            </div>
            {% endif %}
        </div>
        
        <!-- Form Actions -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 30px;">
            <button type="submit" name="save" class="btn btn-success">
                <i class="fas fa-save"></i> 
                {% if editing %}Update{% else %}Create{% endif %} Purchase Order
            </button>
            {% if not editing %}
            <button type="submit" name="save_as_draft" value="true" class="btn btn-primary">
                <i class="fas fa-file-draft"></i> Save as Draft
            </button>
            {% endif %}
            <a href="{% if purchase_order %}{% url 'procurement:purchase_order_detail' purchase_order.pk %}{% else %}{% url 'procurement:purchase_order_list' %}{% endif %}" 
               class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancel
            </a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Form styling */
.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--dark);
    font-size: 0.95em;
}

.form-group label i {
    color: var(--primary);
    width: 20px;
}

.form-control {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid var(--light-gray);
    border-radius: 8px;
    font-size: 1em;
    transition: all 0.3s ease;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
}

.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

/* Table styling for items */
#itemsTable {
    margin-bottom: 20px;
}

#itemsTable th {
    background: var(--light);
    color: var(--dark);
    font-weight: 600;
    padding: 15px;
}

#itemsTable td {
    padding: 12px;
}

.item-row input {
    width: 100%;
    padding: 10px;
    border: 2px solid var(--light-gray);
    border-radius: 6px;
}

.item-row input:focus {
    border-color: var(--primary);
}

/* Checkbox styling */
.checkbox-container input[type="checkbox"] {
    width: 18px;
    height: 18px;
    border-radius: 4px;
    cursor: pointer;
}

.checkbox-container span {
    cursor: pointer;
}

/* Responsive */
@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }
    
    #itemsTable {
        font-size: 0.9em;
    }
    
    #itemsTable th, #itemsTable td {
        padding: 8px;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const formset = document.getElementById('itemsTableBody');
    const totalForms = document.getElementById('id_items-TOTAL_FORMS');
    const formsetPrefix = 'items';
    let formCount = parseInt(totalForms.value);
    
    // Add new item row
    document.getElementById('addItemBtn').addEventListener('click', function() {
        const newForm = document.createElement('tr');
        newForm.className = 'item-row';
        newForm.innerHTML = `
            <td>
                <select name="${formsetPrefix}-${formCount}-item" class="form-control item-select" required>
                    <option value="">Select item...</option>
                    <!-- Items will be populated dynamically -->
                </select>
            </td>
            <td>
                <input type="number" name="${formsetPrefix}-${formCount}-quantity" class="form-control quantity" 
                       min="1" step="1" required placeholder="Qty">
            </td>
            <td>
                <input type="number" name="${formsetPrefix}-${formCount}-unit_price" class="form-control unit-price" 
                       min="0.01" step="0.01" required placeholder="0.00">
            </td>
            <td>
                <span class="item-total" style="font-weight: 600; color: var(--success);">$0.00</span>
            </td>
            <td>
                <button type="button" class="remove-item-btn" style="color: var(--danger); background: none; border: none; cursor: pointer;">
                    <i class="fas fa-trash"></i> Remove
                </button>
                <input type="hidden" name="${formsetPrefix}-${formCount}-id" value="">
            </td>
        `;
        
        formset.appendChild(newForm);
        formCount++;
        totalForms.value = formCount;
        
        // Add event listeners to new inputs
        addEventListenersToRow(newForm);
        
        // Load items for the select (you would fetch from your API)
        loadItemsToSelect(newForm.querySelector('.item-select'));
    });
    
    // Remove item row
    document.addEventListener('click', function(e) {
        if (e.target.closest('.remove-item-btn')) {
            const row = e.target.closest('.item-row');
            if (row && formset.children.length > 1) {
                row.remove();
                formCount--;
                totalForms.value = formCount;
                updateGrandTotal();
            }
        }
    });
    
    // Calculate totals
    function calculateRowTotal(row) {
        const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
        const unitPrice = parseFloat(row.querySelector('.unit-price').value) || 0;
        const total = quantity * unitPrice;
        row.querySelector('.item-total').textContent = `$${total.toFixed(2)}`;
        return total;
    }
    
    function updateGrandTotal() {
        let grandTotal = 0;
        document.querySelectorAll('.item-row').forEach(row => {
            grandTotal += calculateRowTotal(row);
        });
        document.getElementById('grandTotal').textContent = `$${grandTotal.toFixed(2)}`;
    }
    
    function addEventListenersToRow(row) {
        const quantityInput = row.querySelector('.quantity');
        const unitPriceInput = row.querySelector('.unit-price');
        
        [quantityInput, unitPriceInput].forEach(input => {
            input.addEventListener('input', updateGrandTotal);
        });
    }
    
    // Initialize existing rows
    document.querySelectorAll('.item-row').forEach(row => {
        addEventListenersToRow(row);
    });
    
    // Initial calculation
    updateGrandTotal();
    
    // Auto-fill department based on employee (simplified example)
    const requestedBySelect = document.getElementById('id_requested_by');
    const departmentInput = document.getElementById('id_department');
    
    requestedBySelect?.addEventListener('change', function() {
        // In a real app, you'd make an AJAX call here to get employee details
        // For now, we'll just clear the department
        if (departmentInput) departmentInput.value = '';
    });
    
    // Load items function (you'll need to implement this properly)
    function loadItemsToSelect(selectElement) {
        // This should be an AJAX call to your server
        // For now, we'll add some placeholder options
        const items = [
            {id: 1, name: 'Office Chair'},
            {id: 2, name: 'Laptop'},
            {id: 3, name: 'Desk'},
            {id: 4, name: 'Monitor'},
            {id: 5, name: 'Keyboard'}
        ];
        
        items.forEach(item => {
            const option = document.createElement('option');
            option.value = item.id;
            option.textContent = item.name;
            selectElement.appendChild(option);
        });
    }
    
    // Initialize all selects
    document.querySelectorAll('.item-select').forEach(select => {
        if (select.children.length <= 1) { // Only has default option
            loadItemsToSelect(select);
        }
    });
});
</script>
{% endblock %}