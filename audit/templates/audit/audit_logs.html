{% extends 'audit/base.html' %}
{% load static %}

{% block title %}Audit Logs - Cornel Simba{% endblock %}
{% block header_title %}Audit Logs{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/audit_logs.css">
{% endblock %}

{% block content %}
<div class="audit-container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-title">
            <div class="page-icon">
                <i class="fas fa-history"></i>
            </div>
            <div class="page-title-text">
                <h1>Audit Logs</h1>
                <p>System Activity Tracker â€¢ Enterprise Security</p>
            </div>
        </div>
        
        <div class="header-actions">
            <a href="/" class="header-btn secondary">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </a>
            <button class="header-btn" onclick="document.getElementById('downloadInfoModal').style.display = 'flex'" style="background: #9b59b6; color: white;">
                <i class="fas fa-download"></i>
                <span>Download</span>
            </button>
            <a href="/accounts/logout/" class="header-btn danger">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </a>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="quick-stats">
        <div class="stat-card" onclick="window.location='?time_period=today'">
            <div class="stat-icon total">
                <i class="fas fa-database"></i>
            </div>
            <div class="stat-content">
                <h3>{{ total_count|default:"0" }}</h3>
                <p>Total Logs</p>
            </div>
        </div>
        
        <div class="stat-card" onclick="window.location='?time_period=today'">
            <div class="stat-icon today">
                <i class="fas fa-calendar-day"></i>
            </div>
            <div class="stat-content">
                <h3>{{ today_logs|default:"0" }}</h3>
                <p>Today's Activities</p>
            </div>
        </div>
        
        <div class="stat-card" onclick="window.location='?group_by=user'">
            <div class="stat-icon users">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-content">
                <h3>{{ unique_users|default:"0" }}</h3>
                <p>Active Users</p>
            </div>
        </div>
        
        <div class="stat-card" onclick="window.location='?group_by=module'">
            <div class="stat-icon modules">
                <i class="fas fa-cubes"></i>
            </div>
            <div class="stat-content">
                <h3>{{ modules_count|default:"0" }}</h3>
                <p>Active Modules</p>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <section class="filter-section">
        <div class="filter-header">
            <h2>
                <i class="fas fa-filter"></i>
                Filter Audit Logs
            </h2>
            <button class="filter-toggle" id="filterToggle">
                <i class="fas fa-sliders-h"></i>
                Toggle Filters
            </button>
        </div>
        
        <!-- Quick Filter Chips -->
        <div class="quick-filters-chips">
            <button class="filter-chip {% if filter_values.time_period == 'today' %}active{% endif %}" 
                    onclick="setTimePeriod('today')">
                <i class="fas fa-calendar-day"></i>
                Today
            </button>
            <button class="filter-chip {% if filter_values.time_period == 'week' %}active{% endif %}" 
                    onclick="setTimePeriod('week')">
                <i class="fas fa-calendar-week"></i>
                7 Days
            </button>
            <button class="filter-chip {% if filter_values.time_period == 'month' %}active{% endif %}" 
                    onclick="setTimePeriod('month')">
                <i class="fas fa-calendar-alt"></i>
                30 Days
            </button>
        </div>
        
        <!-- Filter Form -->
        <form method="get" id="auditFilterForm" class="filter-form">
            <input type="hidden" name="time_period" id="timePeriod" value="{{ filter_values.time_period }}">
            
            <div class="form-group">
                <label for="userFilter">
                    <i class="fas fa-user"></i>
                    Username
                </label>
                <input type="text" id="userFilter" name="user" class="form-control" 
                       placeholder="Search by username..." value="{{ filter_values.user }}">
            </div>
            
            <div class="form-group">
                <label for="moduleFilter">
                    <i class="fas fa-cube"></i>
                    Module
                </label>
                <select id="moduleFilter" name="module" class="form-control">
                    <option value="">All Modules</option>
                    {% for code, name in module_choices %}
                    <option value="{{ code }}" {% if filter_values.module == code %}selected{% endif %}>
                        {{ name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="actionFilter">
                    <i class="fas fa-bolt"></i>
                    Action Type
                </label>
                <select id="actionFilter" name="action" class="form-control">
                    <option value="">All Actions</option>
                    {% for code, name in action_choices %}
                    <option value="{{ code }}" {% if filter_values.action == code %}selected{% endif %}>
                        {{ name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label>
                    <i class="fas fa-calendar"></i>
                    Date Range
                </label>
                <div class="date-range">
                    <input type="date" name="date_from" class="form-control" 
                           value="{{ filter_values.date_from }}" placeholder="From">
                    <input type="date" name="date_to" class="form-control" 
                           value="{{ filter_values.date_to }}" placeholder="To">
                </div>
            </div>
            
            <div class="form-group">
                <label for="searchFilter">
                    <i class="fas fa-search"></i>
                    Search Text
                </label>
                <input type="text" id="searchFilter" name="q" class="form-control" 
                       placeholder="Search in descriptions..." value="{{ filter_values.q }}">
            </div>
            
            <div class="filter-actions">
                <button type="submit" class="header-btn primary">
                    <i class="fas fa-search"></i>
                    <span>Apply Filters</span>
                </button>
                <button type="button" class="header-btn secondary" onclick="clearAllFilters()">
                    <i class="fas fa-times"></i>
                    <span>Clear All</span>
                </button>
            </div>
        </form>
    </section>

 <!-- Export Section -->
<section class="export-section">
    <div class="export-header">
        <h2>
            <i class="fas fa-file-export"></i>
            Export Options
        </h2>
        <div class="export-options">
            <button class="export-btn pdf" onclick="downloadCurrentView()">
                <i class="fas fa-file-pdf"></i>
                <span>Download PDF</span>
            </button>
            <button class="export-btn print" onclick="printReport()">
                <i class="fas fa-print"></i>
                <span>Print</span>
            </button>
        </div>
    </div>

    
    <!-- Export Information -->
    <div class="export-info">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
            <i class="fas fa-info-circle"></i>
            <strong>Download Information:</strong>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 0.85rem;">
            <div>
                <i class="fas fa-file-pdf" style="color: #e74c3c;"></i>
                <strong>PDF Download:</strong> Downloads all filtered records as PDF
            </div>
            <div>
                <i class="fas fa-print" style="color: #f39c12;"></i>
                <strong>Print:</strong> Prints current page view
            </div>
        </div>
    </div>
</section>

    <!-- Audit Logs -->
    <section class="logs-container">
        <div class="logs-header">
            <h3>
                <i class="fas fa-history"></i>
                Activity Logs
            </h3>
            <div class="logs-meta">
                <span>
                    <i class="fas fa-database"></i>
                    {{ logs.paginator.count }} records
                </span>
                <span>
                    <i class="fas fa-file-alt"></i>
                    Page {{ logs.number }} of {{ logs.paginator.num_pages }}
                </span>
            </div>
        </div>
        
        <!-- Mobile View (Cards) -->
        <div class="mobile-logs-view">
            {% for log in logs %}
            <div class="log-card">
                <div class="log-card-header">
                    <div class="log-date">
                        <span class="date">{{ log.timestamp|date:"M d, Y" }}</span>
                        <span class="time">{{ log.timestamp|time:"H:i:s" }}</span>
                    </div>
                    <span class="log-badge badge-{{ log.action|lower }}">
                        {{ log.get_action_display }}
                    </span>
                </div>
                
                <div class="log-card-body">
                    <div class="log-user">
                        <i class="fas fa-user"></i>
                        {{ log.user.username|default:"System" }}
                    </div>
                    
                    <div class="log-module">
                        <i class="fas fa-cube"></i>
                        {{ log.get_module_display }}
                    </div>
                    
                    <p class="log-description">
                        {{ log.description|truncatechars:100 }}
                    </p>
                    
                    {% if log.object_type %}
                    <div class="log-object">
                        <i class="fas fa-tag"></i>
                        {{ log.object_type }}
                        {% if log.object_id %}#{{ log.object_id }}{% endif %}
                    </div>
                    {% endif %}
                    
                    {% if log.ip_address %}
                    <div class="log-ip">
                        <i class="fas fa-network-wired"></i>
                        {{ log.ip_address }}
                    </div>
                    {% endif %}
                </div>
                
                <div class="log-card-footer">
                    <a href="{% url 'audit:audit_log_detail' log.id %}" class="view-btn">
                        <i class="fas fa-eye"></i>
                        View Details
                    </a>
                </div>
            </div>
            {% empty %}
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="fas fa-inbox"></i>
                </div>
                <h4>No audit logs found</h4>
                <p>Try adjusting your filters or search criteria</p>
                <button class="header-btn secondary" onclick="clearAllFilters()">
                    <i class="fas fa-times"></i>
                    Clear Filters
                </button>
            </div>
            {% endfor %}
        </div>
        
        <!-- Desktop View (Table) -->
        <div class="table-container">
            <table class="audit-table">
                <thead>
                    <tr>
                        <th>Date & Time</th>
                        <th>User</th>
                        <th>Action</th>
                        <th>Module</th>
                        <th>Description</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr>
                        <td>
                            <div class="datetime-cell">
                                <div class="date">{{ log.timestamp|date:"M d, Y" }}</div>
                                <div class="time">{{ log.timestamp|time:"H:i:s" }}</div>
                            </div>
                        </td>
                        <td>
                            <div class="user-cell">
                                <div class="username">{{ log.user.username|default:"System" }}</div>
                                {% if log.ip_address %}
                                <div class="ip">{{ log.ip_address }}</div>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <span class="log-badge badge-{{ log.action|lower }}">
                                {{ log.get_action_display }}
                            </span>
                        </td>
                        <td>
                            <span class="module-tag">{{ log.get_module_display }}</span>
                        </td>
                        <td>
                            <div class="description-cell">
                                <p>{{ log.description|truncatechars:80 }}</p>
                                {% if log.object_type %}
                                <div class="object-info">
                                    <i class="fas fa-tag"></i>
                                    {{ log.object_type }}
                                    {% if log.object_id %}#{{ log.object_id }}{% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <a href="{% url 'audit:audit_log_detail' log.id %}" class="view-btn">
                                <i class="fas fa-eye"></i>
                                View
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <div class="empty-state-icon">
                                    <i class="fas fa-inbox"></i>
                                </div>
                                <h4>No audit logs found</h4>
                                <p>Try adjusting your filters or search criteria</p>
                                <button class="header-btn secondary" onclick="clearAllFilters()">
                                    <i class="fas fa-times"></i>
                                    Clear Filters
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>

    <!-- Pagination -->
    {% if logs.has_other_pages %}
    <section class="pagination-section">
        <div class="pagination-container">
            <div class="pagination-info">
                Showing {{ logs.start_index }} to {{ logs.end_index }} of {{ logs.paginator.count }} entries
            </div>
            
            <nav class="pagination">
                {% if logs.has_previous %}
                <a href="?page=1{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                   class="pagination-link" title="First Page">
                    <i class="fas fa-angle-double-left"></i>
                    <span>First</span>
                </a>
                <a href="?page={{ logs.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                   class="pagination-link" title="Previous">
                    <i class="fas fa-angle-left"></i>
                    <span>Previous</span>
                </a>
                {% else %}
                <span class="pagination-link disabled">
                    <i class="fas fa-angle-double-left"></i>
                    <span>First</span>
                </span>
                <span class="pagination-link disabled">
                    <i class="fas fa-angle-left"></i>
                    <span>Previous</span>
                </span>
                {% endif %}
                
                <div class="page-numbers">
                    {% for num in logs.paginator.page_range %}
                        {% if logs.number == num %}
                        <span class="page-number active">{{ num }}</span>
                        {% elif num > logs.number|add:'-3' and num < logs.number|add:'3' %}
                        <a href="?page={{ num }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                           class="page-number">{{ num }}</a>
                        {% endif %}
                    {% endfor %}
                </div>
                
                {% if logs.has_next %}
                <a href="?page={{ logs.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                   class="pagination-link" title="Next">
                    <span>Next</span>
                    <i class="fas fa-angle-right"></i>
                </a>
                <a href="?page={{ logs.paginator.num_pages }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                   class="pagination-link" title="Last Page">
                    <span>Last</span>
                    <i class="fas fa-angle-double-right"></i>
                </a>
                {% else %}
                <span class="pagination-link disabled">
                    <span>Next</span>
                    <i class="fas fa-angle-right"></i>
                </span>
                <span class="pagination-link disabled">
                    <span>Last</span>
                    <i class="fas fa-angle-double-right"></i>
                </span>
                {% endif %}
            </nav>
            
            <div class="page-size-selector">
                <select onchange="changePageSize(this.value)">
                    <option value="10" {% if request.GET.page_size == '10' %}selected{% endif %}>10 per page</option>
                    <option value="25" {% if request.GET.page_size == '25' or not request.GET.page_size %}selected{% endif %}>25 per page</option>
                    <option value="50" {% if request.GET.page_size == '50' %}selected{% endif %}>50 per page</option>
                    <option value="100" {% if request.GET.page_size == '100' %}selected{% endif %}>100 per page</option>
                </select>
            </div>
        </div>
    </section>
    {% endif %}
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <h3 id="loadingMessage">Processing...</h3>
    <p>Please wait</p>
</div>

<!-- Download Info Modal -->
<div id="downloadInfoModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
    <div style="background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="color: #2c3e50; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-download"></i>
                PDF Download Options
            </h3>
            <button onclick="document.getElementById('downloadInfoModal').style.display = 'none'" style="background: none; border: none; font-size: 1.5rem; color: #7f8c8d; cursor: pointer;">
                &times;
            </button>
        </div>
        
        <div style="margin-bottom: 25px;">
            <p style="color: #7f8c8d; margin-bottom: 15px;">Choose what to download:</p>
            
            <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                <button onclick="downloadCurrentView(); document.getElementById('downloadInfoModal').style.display = 'none';" 
                        style="display: flex; align-items: center; gap: 15px; padding: 15px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                    <div style="background: #e74c3c; color: white; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">
                        <i class="fas fa-filter"></i>
                    </div>
                    <div style="text-align: left;">
                        <div style="font-weight: 600; color: #2c3e50;">Download Filtered Results</div>
                        <div style="font-size: 0.9rem; color: #7f8c8d;">Current search & filter results</div>
                    </div>
                </button>
                
                <button onclick="downloadAllLogs(); document.getElementById('downloadInfoModal').style.display = 'none';" 
                        style="display: flex; align-items: center; gap: 15px; padding: 15px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                    <div style="background: #9b59b6; color: white; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">
                        <i class="fas fa-database"></i>
                    </div>
                    <div style="text-align: left;">
                        <div style="font-weight: 600; color: #2c3e50;">Download ALL Logs</div>
                        <div style="font-size: 0.9rem; color: #7f8c8d;">Ignore filters, download everything</div>
                    </div>
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>


{{% block extra_js %}
<script>
    // Filter toggle for mobile
    document.getElementById('filterToggle').addEventListener('click', function() {
        document.getElementById('auditFilterForm').classList.toggle('show');
    });
    
    // Time period filter
    function setTimePeriod(period) {
        document.getElementById('timePeriod').value = period;
        document.getElementById('auditFilterForm').submit();
    }
    
    // Clear all filters
    function clearAllFilters() {
        if (confirm('Clear all filters?')) {
            window.location.href = "{% url 'audit:audit_logs' %}";
        }
    }
    
    // ========== PDF DOWNLOAD FUNCTIONS ==========
    
    function downloadCurrentView() {
        showLoading('Generating PDF...');
        const url = new URL(window.location);
        url.searchParams.set('export', 'pdf');
        window.location.href = url.toString();
    }
    
    function downloadAllLogs() {
        if (confirm('Download ALL audit logs?')) {
            showLoading('Generating PDF...');
            window.location.href = "{% url 'audit:audit_logs' %}?export=pdf";
        }
    }
    
    function printReport() {
        window.print();
    }
    
    function changePageSize(size) {
        const url = new URL(window.location);
        url.searchParams.set('page_size', size);
        url.searchParams.set('page', '1');
        window.location.href = url.toString();
    }
    
    // ========== UTILITY FUNCTIONS ==========
    
    function showLoading(message) {
        const overlay = document.getElementById('loadingOverlay');
        const messageEl = document.getElementById('loadingMessage');
        if (messageEl) messageEl.textContent = message;
        if (overlay) {
            overlay.style.display = 'flex';
            setTimeout(() => overlay.style.display = 'none', 10000);
        }
    }
    
    function hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) overlay.style.display = 'none';
    }
    
    document.getElementById('auditFilterForm').addEventListener('submit', function() {
        showLoading('Applying filters...');
    });
</script>
{% endblock %}