{% extends 'finance/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}General Ledger - Finance{% endblock %}

{% block page_title %}üìí General Ledger{% endblock %}

{% block breadcrumb %}
<a href="{% url 'finance:dashboard' %}">Dashboard</a> / General Ledger
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'finance/css/general_ledger.css' %}">
{% endblock %}

{% block content %}
<div class="general-ledger-container">
    <!-- Page Header -->
    <div class="general-ledger-header">
        <h1><i class="fas fa-book"></i> General Ledger</h1>
        <h2>Cornel Simba Mining Enterprise</h2>
    </div>
    
    <!-- Period Display -->
    <div class="ledger-period-display">
        <strong><i class="fas fa-calendar-alt"></i> Reporting Period:</strong> 
        {{ start_date|date:"F j, Y" }} to {{ end_date|date:"F j, Y" }}
    </div>
    
    <!-- Filters Section -->
    <div class="ledger-filters">
        <form method="get" class="filter-form" id="ledgerFilterForm">
            <div class="filter-group">
                <label class="filter-label">Start Date</label>
                <input type="date" name="start_date" class="form-control" 
                       value="{{ request.GET.start_date|default:'' }}">
            </div>
            
            <div class="filter-group">
                <label class="filter-label">End Date</label>
                <input type="date" name="end_date" class="form-control" 
                       value="{{ request.GET.end_date|default:'' }}">
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Account</label>
                <select name="account" class="form-control">
                    <option value="">All Accounts</option>
                    {% for account in all_accounts %}
                    <option value="{{ account.id }}" 
                            {% if request.GET.account == account.id|stringformat:"i" %}selected{% endif %}>
                        {{ account.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-group">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-filter"></i> Apply Filters
                </button>
                {% if request.GET %}
                <a href="{% url 'finance:general_ledger' %}" class="btn btn-secondary" style="margin-top: 8px;">
                    <i class="fas fa-times"></i> Clear Filters
                </a>
                {% endif %}
            </div>
        </form>
    </div>
    
    <!-- Transactions Table -->
    <h3 class="ledger-section-header">
        <i class="fas fa-exchange-alt"></i> All Transactions
    </h3>
    
    <table class="ledger-table transaction-table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Debit Account</th>
                <th>Debit Amount</th>
                <th>Credit Account</th>
                <th>Credit Amount</th>
            </tr>
        </thead>
        <tbody>
            {% for t in transactions %}
            <tr>
                <td class="date-cell">{{ t.date|date:"Y-m-d" }}</td>
                <td class="account-name-cell">{{ t.debit_account.name }}</td>
                <td class="amount-cell debit-total">
                    {{ t.amount|floatformat:2|intcomma }}
                </td>
                <td class="account-name-cell">{{ t.credit_account.name }}</td>
                <td class="amount-cell credit-total">
                    {{ t.amount|floatformat:2|intcomma }}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <h4>No transactions found</h4>
                    <p>Try adjusting your filters or select a different period.</p>
                </td>
            </tr>
            {% endfor %}
        </tbody>
        {% if transactions %}
        <tfoot>
            <tr class="totals-row">
                <td colspan="2"><strong>Totals</strong></td>
                <td class="amount-cell debit-total">
                    <strong>{{ debit_total|floatformat:2|intcomma }}</strong>
                </td>
                <td></td>
                <td class="amount-cell credit-total">
                    <strong>{{ credit_total|floatformat:2|intcomma }}</strong>
                </td>
            </tr>
        </tfoot>
        {% endif %}
    </table>
    
    <!-- Accounts Summary Table -->
    <h3 class="ledger-section-header">
        <i class="fas fa-chart-bar"></i> Accounts Summary
    </h3>
    
    <table class="ledger-table summary-table">
        <thead>
            <tr>
                <th>Account</th>
                <th>Debits</th>
                <th>Credits</th>
                <th>Balance</th>
            </tr>
        </thead>
        <tbody>
            {% for summary in accounts_summary.values %}
            <tr>
                <td class="account-name-cell">{{ summary.account.name }}</td>
                <td class="amount-cell debit-total">
                    {{ summary.debits|floatformat:2|intcomma }}
                </td>
                <td class="amount-cell credit-total">
                    {{ summary.credits|floatformat:2|intcomma }}
                </td>
                <td class="amount-cell">
                    {% with balance=summary.debits|add:"-"|add:summary.credits %}
                    {{ balance|floatformat:2|intcomma }}
                    {% endwith %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="4" class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <h4>No accounts summary available</h4>
                    <p>No transactions found for the selected period.</p>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <!-- Balance Status -->
    <div class="balance-status">
        <div class="balance-status-header">
            <i class="fas fa-balance-scale"></i> Ledger Balance Status
        </div>
        
        <div class="balance-status-value {% if balance_difference == 0 %}balanced{% else %}not-balanced{% endif %}">
            {% if balance_difference == 0 %}
                <i class="fas fa-check-circle"></i> Balanced
            {% else %}
                <i class="fas fa-times-circle"></i> Not Balanced
            {% endif %}
        </div>
        
        <div class="balance-difference">
            {% if balance_difference == 0 %}
                ‚úÖ Debits ({{ debit_total|floatformat:2|intcomma }}) = Credits ({{ credit_total|floatformat:2|intcomma }})
            {% else %}
                ‚ö†Ô∏è Difference: Tsh {{ balance_difference|floatformat:2|intcomma }}
            {% endif %}
        </div>
        
        {% if balance_difference != 0 %}
        <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #f39c12;">
            <h4 style="margin: 0 0 10px 0; color: #856404;">
                <i class="fas fa-exclamation-triangle"></i> Action Required
            </h4>
            <p style="margin: 0; color: #856404;">
                The general ledger is not balanced. Please review the transactions and ensure all entries are properly recorded.
            </p>
        </div>
        {% endif %}
    </div>
    
    <!-- Export Options -->
    <div style="margin-top: 30px; text-align: center;">
        <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
            <button onclick="window.print()" class="btn btn-secondary">
                <i class="fas fa-print"></i> Print Ledger
            </button>
            <a href="{% url 'finance:reports' %}" class="btn btn-primary">
                <i class="fas fa-chart-bar"></i> View Reports
            </a>
            <a href="{% url 'finance:dashboard' %}" class="btn btn-outline">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
        </div>
    </div>
    <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; text-align: center;">
        <h4 style="margin-bottom: 15px;">
            <i class="fas fa-download"></i> Download Options
        </h4>
        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
            <!-- PDF Download Button -->
            <a href="{% url 'finance:download_general_ledger_pdf' %}" 
               class="btn btn-danger" 
               style="background: #dc3545; color: white; padding: 10px 20px; border-radius: 5px; text-decoration: none; display: inline-flex; align-items: center; gap: 8px;">
                <i class="fas fa-file-pdf"></i> Download PDF
            </a>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
// Format all currency amounts
document.addEventListener('DOMContentLoaded', function() {
    // Format transaction amounts
    document.querySelectorAll('.amount-cell').forEach(element => {
        const text = element.textContent;
        const amount = text.replace(/[^\d.]/g, '');
        
        if (amount && !isNaN(parseFloat(amount))) {
            const num = parseFloat(amount);
            const isDebit = element.classList.contains('debit-total');
            
            if (isDebit) {
                element.textContent = 'Tsh ' + num.toLocaleString('en-US');
            } else if (element.classList.contains('credit-total')) {
                element.textContent = 'Tsh ' + num.toLocaleString('en-US');
            } else {
                element.textContent = 'Tsh ' + Math.abs(num).toLocaleString('en-US');
            }
        }
    });
});

// Auto-submit form when dates change
const startDateInput = document.querySelector('input[name="start_date"]');
const endDateInput = document.querySelector('input[name="end_date"]');
const filterForm = document.getElementById('ledgerFilterForm');

if (startDateInput && endDateInput && filterForm) {
    let submitTimer;
    
    function submitForm() {
        clearTimeout(submitTimer);
        submitTimer = setTimeout(() => {
            filterForm.submit();
        }, 500);
    }
    
    startDateInput.addEventListener('change', submitForm);
    endDateInput.addEventListener('change', submitForm);
}

// Auto-set end date to today if empty
if (endDateInput && !endDateInput.value) {
    const today = new Date().toISOString().split('T')[0];
    endDateInput.value = today;
}

// Auto-set start date to beginning of month if empty
if (startDateInput && !startDateInput.value) {
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    startDateInput.value = firstDay.toISOString().split('T')[0];
}
</script>
{% endblock %}