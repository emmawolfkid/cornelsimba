{% extends 'sales/base.html' %}
{% load static %}

{% block title %}Add Payment - Sale {{ sale.sale_number }} - CornelSimba ERP{% endblock %}
{% block page_title %}Add Payment{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/payment_form.css' %}">
{% endblock %}

{% block content %}
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div class="payment-container">
        <!-- Payment Header -->
        <div class="payment-header">
            <nav aria-label="breadcrumb" class="payment-breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'sales:sale_list' %}" class="text-decoration-none">Sales</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'sales:sale_detail' sale.pk %}" class="text-decoration-none">Sale {{ sale.sale_number }}</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Add Payment</li>
                </ol>
            </nav>
            
            <div class="d-flex justify-content-between align-items-start align-items-md-center flex-wrap gap-3">
                <div>
                    <h1 class="payment-title">Add Payment</h1>
                    <p class="payment-subtitle">Sale: {{ sale.sale_number }} - {{ sale.customer.name }}</p>
                </div>
                <a href="{% url 'sales:sale_detail' sale.pk %}" class="btn-custom btn-outline-custom">
                    <i class="bi bi-arrow-left"></i>
                    Back to Sale
                </a>
            </div>
        </div>

        <!-- Main Card -->
        <div class="card-custom payment-form-card">
            <div class="card-body-custom p-4">
                <!-- Sale Information -->
                <div class="sale-info-card">
                    <h4 class="sale-info-card-title">Sale Information</h4>
                    <div class="sale-info-grid">
                        <div class="sale-info-item">
                            <div class="sale-info-label">Customer</div>
                            <div class="sale-info-value">{{ sale.customer.name }}</div>
                        </div>
                        
                        <div class="sale-info-item">
                            <div class="sale-info-label">Total Amount</div>
                            <div class="sale-info-value currency">Tsh {{ sale.net_amount|floatformat:0|default:"0" }}</div>
                        </div>
                        
                        <div class="sale-info-item">
                            <div class="sale-info-label">Paid Amount</div>
                            <div class="sale-info-value currency">Tsh {{ sale.amount_paid|floatformat:0|default:"0" }}</div>
                        </div>
                        
                        <div class="sale-info-item">
                            <div class="sale-info-label">Balance Due</div>
                            <div class="sale-info-value currency">Tsh {{ sale.balance_due|floatformat:0|default:"0" }}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Balance Highlight -->
                {% if sale.balance_due > 0 %}
                <div class="balance-highlight">
                    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                        <div>
                            <h5 class="balance-title">Outstanding Balance</h5>
                            <p class="balance-text">Maximum amount you can pay: 
                                <span class="fw-bold">Tsh {{ sale.balance_due|floatformat:0 }}</span>
                            </p>
                        </div>
                        <div class="balance-amount">
                            Tsh {{ sale.balance_due|floatformat:0 }}
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Payment Summary -->
                <div class="payment-summary">
                    <h5 class="payment-summary-title">Payment Summary</h5>
                    <div class="payment-summary-row">
                        <span>Sale Total:</span>
                        <span class="payment-summary-amount currency-display">{{ sale.net_amount|floatformat:0|default:"0" }}</span>
                    </div>
                    <div class="payment-summary-row">
                        <span>Already Paid:</span>
                        <span class="payment-summary-amount currency-display">{{ sale.amount_paid|floatformat:0|default:"0" }}</span>
                    </div>
                    <div class="payment-summary-row summary-total">
                        <span>Remaining Balance:</span>
                        <span class="payment-summary-amount currency-display">{{ sale.balance_due|floatformat:0|default:"0" }}</span>
                    </div>
                </div>
                
                <!-- Payment Form -->
                <form method="post" id="paymentForm" novalidate>
                    {% csrf_token %}
                    
                    {% if form.errors %}
                    <div class="alert-custom alert-danger">
                        <h6 class="alert-heading">Please fix the following errors:</h6>
                        <ul class="mb-0">
                            {% for field in form %}
                                {% for error in field.errors %}
                                <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                            {% for error in form.non_field_errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    
                    <h3 class="form-section-title">Payment Details</h3>
                    
                    <div class="form-grid">
                        <!-- Amount -->
                        <div class="filter-group currency-input-group">
                            <label for="id_amount" class="filter-label required-field">Payment Amount</label>
                            <span class="currency-prefix">Tsh</span>
                            {{ form.amount }}
                            <small class="text-muted">Amount in Tanzanian Shillings</small>
                            {% if form.amount.errors %}
                            <div class="invalid-feedback-custom">
                                {{ form.amount.errors }}
                            </div>
                            {% endif %}
                     <!-- Quick Amount Buttons -->
{% if sale.balance_due > 0 %}
<div class="quick-amount-buttons">
    <button type="button" class="quick-amount-btn" data-percentage="25">
        25%
    </button>
    <button type="button" class="quick-amount-btn" data-percentage="50">
        50%
    </button>
    <button type="button" class="quick-amount-btn" data-percentage="75">
        75%
    </button>
    <button type="button" class="quick-amount-btn" data-percentage="100">
        100%
    </button>
</div>
{% endif %}
                        </div>
                        
                        <!-- Payment Method -->
                        <div class="filter-group">
                            <label for="id_payment_method" class="filter-label required-field">Payment Method</label>
                            {{ form.payment_method }}
                            {% if form.payment_method.errors %}
                            <div class="invalid-feedback-custom">
                                {{ form.payment_method.errors }}
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Payment Date -->
                        <div class="filter-group">
                            <label for="id_payment_date" class="filter-label">Payment Date</label>
                            {{ form.payment_date }}
                            {% if form.payment_date.errors %}
                            <div class="invalid-feedback-custom">
                                {{ form.payment_date.errors }}
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Reference Number -->
                        <div class="filter-group">
                            <label for="id_reference_number" class="filter-label">Reference Number</label>
                            {{ form.reference_number }}
                            <small class="text-muted">Transaction ID, Receipt No., etc.</small>
                            {% if form.reference_number.errors %}
                            <div class="invalid-feedback-custom">
                                {{ form.reference_number.errors }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Conditional Fields -->
                    <div id="bankFields" class="conditional-fields">
                        <h5 class="conditional-fields-title">Bank Transfer Details</h5>
                        <div class="form-grid">
                            <div class="filter-group">
                                <label for="id_bank_name" class="filter-label">Bank Name</label>
                                {{ form.bank_name }}
                            </div>
                            <div class="filter-group">
                                <label for="id_account_number" class="filter-label">Account Number</label>
                                {{ form.account_number }}
                            </div>
                        </div>
                    </div>
                    
                    <div id="chequeFields" class="conditional-fields">
                        <h5 class="conditional-fields-title">Cheque Details</h5>
                        <div class="form-grid">
                            <div class="filter-group">
                                <label for="id_cheque_number" class="filter-label">Cheque Number</label>
                                {{ form.cheque_number }}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notes -->
                    <div class="mt-4">
                        <label for="id_notes" class="filter-label">Notes</label>
                        {{ form.notes }}
                        <small class="text-muted">Any additional information about this payment</small>
                        {% if form.notes.errors %}
                        <div class="invalid-feedback-custom">
                            {{ form.notes.errors }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="form-actions">
                        <div class="d-flex justify-content-between flex-wrap gap-3">
                            <a href="{% url 'sales:sale_detail' sale.pk %}" class="btn-custom btn-outline-custom">
                                <i class="bi bi-x-lg"></i>
                                Cancel
                            </a>
                            <button type="submit" class="btn-custom btn-success-custom" id="submitBtn">
                                <i class="bi bi-check-lg"></i>
                                Record Payment
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize form controls with custom classes
        const formControls = document.querySelectorAll('#paymentForm input, #paymentForm select, #paymentForm textarea');
        formControls.forEach(control => {
            if (!control.classList.contains('form-control-custom')) {
                control.classList.add('form-control-custom');
            }
        });
        
        // Get form elements
        const amountInput = document.getElementById('id_amount');
        const paymentMethod = document.getElementById('id_payment_method');
        const bankFields = document.getElementById('bankFields');
        const chequeFields = document.getElementById('chequeFields');
        const form = document.getElementById('paymentForm');
        const submitBtn = document.getElementById('submitBtn');
        const loadingOverlay = document.getElementById('loadingOverlay');
        
        // Auto-fill with balance due if empty
        if (amountInput && !amountInput.value) {
            const balanceDue = parseFloat('{{ sale.balance_due }}') || 0;
            amountInput.value = balanceDue.toFixed(0);
        }
        
        // Payment method conditional fields
        function toggleConditionalFields() {
            const method = paymentMethod.value;
            
            // Hide all conditional fields
            bankFields.style.display = 'none';
            chequeFields.style.display = 'none';
            
            // Show relevant fields
            if (method === 'BANK_TRANSFER') {
                bankFields.style.display = 'block';
            } else if (method === 'CHEQUE') {
                chequeFields.style.display = 'block';
            }
        }
        
        // Initial toggle
        toggleConditionalFields();
        
        // Toggle on change
        paymentMethod.addEventListener('change', toggleConditionalFields);
        
        // Form validation
        if (form) {
            form.addEventListener('submit', function(e) {
                // Validate amount
                const amount = parseFloat(amountInput.value.replace(/,/g, '')) || 0;
                const balanceDue = parseFloat('{{ sale.balance_due }}') || 0;
                
                if (amount <= 0) {
                    e.preventDefault();
                    alert('Payment amount must be greater than 0.');
                    amountInput.focus();
                    return;
                }
                
                if (amount > balanceDue) {
                    e.preventDefault();
                    alert(`Payment amount (Tsh ${amount.toLocaleString()}) exceeds balance due (Tsh ${balanceDue.toLocaleString()}).`);
                    amountInput.focus();
                    return;
                }
                
                // Validate payment method
                if (!paymentMethod.value) {
                    e.preventDefault();
                    alert('Please select a payment method.');
                    paymentMethod.focus();
                    return;
                }
                
                // Show loading overlay
                if (loadingOverlay) {
                    loadingOverlay.classList.add('show');
                }
                
                // Disable submit button to prevent double submission
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = `
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        Recording Payment...
                    `;
                }
            });
        }
        
        // Real-time amount validation
        if (amountInput) {
            amountInput.addEventListener('input', function() {
                const rawValue = this.value.replace(/,/g, '');
                const amount = parseFloat(rawValue) || 0;
                const balanceDue = parseFloat('{{ sale.balance_due }}') || 0;
                
                // Clear previous errors
                this.classList.remove('payment-error');
                const errorMessage = this.parentElement.querySelector('.payment-error-message');
                if (errorMessage) {
                    errorMessage.classList.remove('show');
                }
                
                if (amount > balanceDue) {
                    this.classList.add('payment-error');
                    
                    // Create or update error message
                    let errorMsg = this.parentElement.querySelector('.payment-error-message');
                    if (!errorMsg) {
                        errorMsg = document.createElement('div');
                        errorMsg.className = 'payment-error-message';
                        this.parentElement.appendChild(errorMsg);
                    }
                    errorMsg.textContent = `Amount exceeds balance due (Tsh ${balanceDue.toLocaleString()})`;
                    errorMsg.classList.add('show');
                }
                
                // Format display
                if (rawValue && !isNaN(parseFloat(rawValue))) {
                    const formatted = parseFloat(rawValue).toLocaleString('en-US', {
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    });
                    
                    // Only update if the formatted value is different
                    if (this.value !== formatted) {
                        this.value = formatted;
                    }
                }
            });
            
            // Remove commas on focus for easier editing
            amountInput.addEventListener('focus', function() {
                this.value = this.value.replace(/,/g, '');
                this.style.fontSize = '16px'; // Prevent iOS zoom
            });
            
            amountInput.addEventListener('blur', function() {
                this.style.fontSize = '';
                if (this.value) {
                    const num = parseFloat(this.value.replace(/,/g, ''));
                    if (!isNaN(num)) {
                        this.value = num.toLocaleString('en-US', {
                            minimumFractionDigits: 0,
                            maximumFractionDigits: 0
                        });
                    }
                }
            });
        }
        
   // Quick amount buttons - Percentage based
const quickAmountButtons = document.querySelectorAll('.quick-amount-btn');
quickAmountButtons.forEach(btn => {
    btn.addEventListener('click', function() {
        const percentage = parseInt(this.getAttribute('data-percentage')) / 100;
        const balanceDue = parseFloat('{{ sale.balance_due }}') || 0;
        const amount = Math.round(balanceDue * percentage);
        
        if (amountInput) {
            amountInput.value = amount.toLocaleString('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
            
            // Trigger validation
            amountInput.dispatchEvent(new Event('input'));
            amountInput.focus();
        }
    });
});
        // Set today's date as default for payment date
        const paymentDateInput = document.getElementById('id_payment_date');
        if (paymentDateInput && !paymentDateInput.value) {
            const today = new Date().toISOString().split('T')[0];
            paymentDateInput.value = today;
        }
        
        // Prevent iOS zoom on inputs
        const textInputs = document.querySelectorAll('input[type="text"], input[type="number"]');
        textInputs.forEach(input => {
            input.addEventListener('focus', function() {
                this.style.fontSize = '16px';
            });
            
            input.addEventListener('blur', function() {
                this.style.fontSize = '';
            });
        });
        
        // Touch optimization
        if ('ontouchstart' in window) {
            const touchElements = document.querySelectorAll('.btn-custom, .quick-amount-btn');
            touchElements.forEach(el => {
                el.style.minHeight = '44px';
                el.style.minWidth = '44px';
            });
            
            // Touch feedback
            touchElements.forEach(el => {
                el.addEventListener('touchstart', function() {
                    this.style.opacity = '0.7';
                });
                
                el.addEventListener('touchend', function() {
                    this.style.opacity = '1';
                });
            });
        }
    });
</script>
{% endblock %}