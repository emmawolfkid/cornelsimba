{% extends 'sales/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Sales Dashboard - CornelSimba ERP{% endblock %}
{% block page_title %}Sales Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<style>
    /* Additional responsive fixes */
    .stats-value {
        font-variant-numeric: tabular-nums;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .currency-number {
        font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
        letter-spacing: -0.5px;
    }
    
    /* Mobile optimizations */
    @media (max-width: 768px) {
        .stats-card {
            flex-direction: row;
            text-align: left;
            padding: 1rem;
        }
        
        .stats-icon {
            width: 48px;
            height: 48px;
            font-size: 1.25rem;
        }
        
        .stats-content h3 {
            font-size: 1.25rem;
        }
    }
</style>
{% endblock %}

{% block content %}
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="header-info">
            <h1>Sales Dashboard</h1>
            <p class="text-muted">{{ today|date:"F j, Y" }} â€¢ Overview of your sales performance</p>
        </div>
        <div class="header-actions">
            <a href="{% url 'sales:sale_create' %}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i>
                New Sale
            </a>
            <a href="{% url 'sales:customer_create' %}" class="btn btn-success">
                <i class="bi bi-person-plus"></i>
                New Customer
            </a>
            <a href="{% url 'sales:sales_report' %}" class="btn btn-outline-secondary">
                <i class="bi bi-bar-chart"></i>
                Reports
            </a>
        </div>
    </div>
    
    <!-- Stats Cards Grid -->
    <div class="row g-3 mb-4">
        <!-- Total Revenue Card -->
        <div class="col-xl-3 col-md-6 col-sm-6">
            <div class="stats-card revenue-card">
                <div class="stats-icon">
                    <i class="bi bi-currency-exchange"></i>
                </div>
                <div class="stats-content">
                    <h6>Total Revenue</h6>
                    <h3 class="currency-number">Tsh {{ total_revenue|floatformat:0|intcomma|default:"0" }}</h3>
                    <div class="stats-trend positive">
                        <i class="bi bi-arrow-up"></i>
                        <span>All time</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Total Sales Card -->
        <div class="col-xl-3 col-md-6 col-sm-6">
            <div class="stats-card sales-card">
                <div class="stats-icon">
                    <i class="bi bi-cart-check"></i>
                </div>
                <div class="stats-content">
                    <h6>Total Sales</h6>
                    <h3 class="currency-number">{{ total_sales|default:"0"|intcomma }}</h3>
                    <div class="stats-trend positive">
                        <i class="bi bi-arrow-up"></i>
                        <span>Completed sales</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Monthly Revenue Card -->
        <div class="col-xl-3 col-md-6 col-sm-6">
            <div class="stats-card monthly-card">
                <div class="stats-icon">
                    <i class="bi bi-calendar-check"></i>
                </div>
                <div class="stats-content">
                    <h6>Monthly Revenue</h6>
                    <h3 class="currency-number">Tsh {{ monthly_revenue|floatformat:0|intcomma|default:"0" }}</h3>
                    <div class="stats-trend positive">
                        <i class="bi bi-calendar-month"></i>
                        <span>This month</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pending Sales Card -->
        <div class="col-xl-3 col-md-6 col-sm-6">
            <div class="stats-card pending-card">
                <div class="stats-icon">
                    <i class="bi bi-clock-history"></i>
                </div>
                <div class="stats-content">
                    <h6>Pending Approval</h6>
                    <h3 class="currency-number">{{ pending_sales|default:"0"|intcomma }}</h3>
                    <div class="stats-trend {% if pending_sales > 0 %}negative{% else %}positive{% endif %}">
                        {% if pending_sales > 0 %}
                        <i class="bi bi-exclamation-triangle"></i>
                        <span>{{ pending_sales }} need review</span>
                        {% else %}
                        <i class="bi bi-check-circle"></i>
                        <span>All processed</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Second Row Cards -->
    <div class="row g-3 mb-4">
        <!-- Active Customers Card -->
        <div class="col-xl-3 col-md-6 col-sm-6">
            <div class="stats-card customers-card">
                <div class="stats-icon">
                    <i class="bi bi-people"></i>
                </div>
                <div class="stats-content">
                    <h6>Active Customers</h6>
                    <h3 class="currency-number">{{ customers_count|default:"0"|intcomma }}</h3>
                    <div class="stats-action">
                        <a href="{% url 'sales:customer_list' %}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-list"></i>
                            View All
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pending Stock Outs Card -->
        <div class="col-xl-3 col-md-6 col-sm-6">
            <div class="stats-card stock-out-card">
                <div class="stats-icon">
                    <i class="bi bi-box-seam"></i>
                </div>
                <div class="stats-content">
                    <h6>Pending Stock Outs</h6>
                    <h3 class="currency-number">{{ pending_stock_out|default:"0"|intcomma }}</h3>
                    <div class="stats-action">
                        {% if pending_stock_out > 0 %}
                        <a href="{% url 'sales:pending_stock_outs' %}" class="btn btn-sm btn-warning">
                            <i class="bi bi-eye"></i>
                            Review Now
                        </a>
                        {% else %}
                        <span class="text-success small">
                            <i class="bi bi-check-circle"></i>
                            All processed
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Weekly Revenue Card -->
        <div class="col-xl-3 col-md-6 col-sm-6">
            <div class="stats-card weekly-card">
                <div class="stats-icon">
                    <i class="bi bi-calendar-week"></i>
                </div>
                <div class="stats-content">
                    <h6>Weekly Revenue</h6>
                    <h3 class="currency-number">Tsh {{ weekly_revenue|floatformat:0|intcomma|default:"0" }}</h3>
                    <div class="stats-trend positive">
                        <i class="bi bi-calendar-week"></i>
                        <span>Last 7 days</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Approved Stock Outs Card -->
        <div class="col-xl-3 col-md-6 col-sm-6">
            <div class="stats-card approved-stock-card">
                <div class="stats-icon">
                    <i class="bi bi-box-check"></i>
                </div>
                <div class="stats-content">
                    <h6>Approved Stock Outs</h6>
                    <h3 class="currency-number">{{ approved_stock_out|default:"0"|intcomma }}</h3>
                    <div class="stats-trend positive">
                        <i class="bi bi-check-circle"></i>
                        <span>Completed</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content Grid -->
    <div class="row g-3">
        <!-- Recent Sales Table -->
        <div class="col-xl-8">
            <div class="card table-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-receipt me-2"></i>
                        Recent Sales
                    </h5>
                    <a href="{% url 'sales:sale_list' %}" class="btn btn-sm btn-outline-primary">
                        View All <i class="bi bi-arrow-right ms-1"></i>
                    </a>
                </div>
                <div class="card-body">
                    {% if recent_sales %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th style="width: 15%">Sale #</th>
                                    <th style="width: 25%">Customer</th>
                                    <th style="width: 15%">Date</th>
                                    <th style="width: 20%">Amount</th>
                                    <th style="width: 15%">Status</th>
                                    <th style="width: 10%">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sale in recent_sales %}
                                <tr>
                                    <td>
                                        <div class="sale-number">
                                            <strong class="text-primary">{{ sale.sale_number }}</strong>
                                            {% if sale.sale_date == today %}
                                            <span class="badge bg-success-subtle text-success ms-1">Today</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="customer-cell">
                                            <div class="customer-avatar">
                                                {{ sale.customer.name|slice:":1"|upper }}
                                            </div>
                                            <div class="customer-info">
                                                <strong class="d-block text-truncate" style="max-width: 150px;">{{ sale.customer.name }}</strong>
                                                <small class="text-muted">{{ sale.customer.phone|default:"No phone" }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ sale.sale_date|date:"M d, Y" }}</td>
                                    <td>
                                        <div class="amount-cell">
                                            <strong class="text-primary">Tsh {{ sale.net_amount|floatformat:0|intcomma }}</strong>
                                            <small class="text-muted d-block">
                                                {% if sale.is_paid %}
                                                <span class="text-success"><i class="bi bi-check-circle"></i> Paid</span>
                                                {% else %}
                                                <span class="text-warning">Due: Tsh {{ sale.balance_due|floatformat:0|intcomma }}</span>
                                                {% endif %}
                                            </small>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="sale-status">
                                            {% if sale.status == 'COMPLETED' %}
                                            <span class="badge bg-success-subtle text-success border border-success-subtle">
                                                <i class="bi bi-check-circle me-1"></i>
                                                Completed
                                            </span>
                                            {% elif sale.status == 'APPROVED' %}
                                            <span class="badge bg-info-subtle text-info border border-info-subtle">
                                                <i class="bi bi-check-circle me-1"></i>
                                                Approved
                                            </span>
                                            {% elif sale.status == 'PENDING' %}
                                            <span class="badge bg-warning-subtle text-warning border border-warning-subtle">
                                                <i class="bi bi-clock me-1"></i>
                                                Pending
                                            </span>
                                            {% elif sale.status == 'DRAFT' %}
                                            <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle">
                                                <i class="bi bi-pencil me-1"></i>
                                                Draft
                                            </span>
                                            {% elif sale.status == 'CANCELLED' %}
                                            <span class="badge bg-danger-subtle text-danger border border-danger-subtle">
                                                <i class="bi bi-x-circle me-1"></i>
                                                Cancelled
                                            </span>
                                            {% elif sale.status == 'STOCK_OUT_PENDING' %}
                                            <span class="badge bg-orange-subtle text-orange border border-orange-subtle">
                                                <i class="bi bi-box me-1"></i>
                                                Stock Out Pending
                                            </span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <a href="{% url 'sales:sale_detail' sale.pk %}" class="btn btn-sm btn-outline-primary" title="View Details">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            {% if sale.status == 'DRAFT' %}
                                            <a href="{% url 'sales:sale_edit' sale.pk %}" class="btn btn-sm btn-outline-secondary" title="Edit Sale">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="empty-state text-center py-5">
                        <div class="empty-icon mb-3">
                            <i class="bi bi-cart-x display-4 text-muted"></i>
                        </div>
                        <h5 class="text-muted">No sales yet</h5>
                        <p class="text-muted mb-4">Start by creating your first sale</p>
                        <a href="{% url 'sales:sale_create' %}" class="btn btn-primary">
                            <i class="bi bi-plus-circle me-1"></i>
                            Create First Sale
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Right Sidebar Cards -->
        <div class="col-xl-4">
            <!-- Top Customers Card -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-trophy me-2"></i>
                        Top Customers
                        <span class="badge bg-primary ms-2">{{ top_customers|length }}</span>
                    </h5>
                </div>
                <div class="card-body p-0">
                    {% if top_customers %}
                    <div class="top-customers-list">
                        {% for customer in top_customers %}
                        <div class="customer-item">
                            <div class="customer-rank">
                                <span class="rank-badge">{{ forloop.counter }}</span>
                            </div>
                            <div class="customer-avatar">
                                {{ customer.customer__name|slice:":1"|upper }}
                            </div>
                            <div class="customer-details">
                                <h6 class="mb-0 text-truncate" style="max-width: 150px;">{{ customer.customer__name|default:"Unknown Customer" }}</h6>
                                <div class="customer-stats">
                                    <span class="text-muted small">
                                        <i class="bi bi-cart3 me-1"></i>
                                        {{ customer.total_sales|default:0 }} sales
                                    </span>
                                </div>
                            </div>
                            <div class="customer-revenue">
                                <strong class="text-success small">Tsh {{ customer.total_amount|default:0|floatformat:0|intcomma }}</strong>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state text-center py-4">
                        <i class="bi bi-people display-5 text-muted mb-3"></i>
                        <p class="text-muted mb-0">No customer data available</p>
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer text-center py-2">
                    <a href="{% url 'sales:customer_list' %}" class="btn btn-sm btn-outline-primary w-100">
                        <i class="bi bi-people me-1"></i>
                        View All Customers
                    </a>
                </div>
            </div>
            
            <!-- Quick Actions Card -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-lightning me-2"></i>
                        Quick Actions
                    </h5>
                </div>
                <div class="card-body p-3">
                    <div class="quick-actions-grid">
                        <a href="{% url 'sales:sales_report' %}" class="quick-action" title="View Sales Reports">
                            <div class="action-icon bg-info-subtle">
                                <i class="bi bi-bar-chart text-info"></i>
                            </div>
                            <span>Sales Report</span>
                        </a>
        
                        <a href="{% url 'sales:payment_list' %}" class="quick-action" title="View Payments">
                            <div class="action-icon bg-success-subtle">
                                <i class="bi bi-cash-coin text-success"></i>
                            </div>
                            <span>Payments</span>
                        </a>
                        <a href="{% url 'sales:pending_stock_outs' %}" class="quick-action" title="View Pending Stock Outs">
                            <div class="action-icon bg-orange-subtle">
                                <i class="bi bi-box text-orange"></i>
                            </div>
                            <span>Stock Outs</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    // Format currency numbers on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Add responsive behavior
        function updateLayout() {
            const width = window.innerWidth;
            const statsCards = document.querySelectorAll('.stats-card');
            
            if (width < 768) {
                // Mobile view
                statsCards.forEach(card => {
                    card.style.flexDirection = 'row';
                    card.style.textAlign = 'left';
                    card.style.padding = '1rem';
                });
            } else {
                // Desktop view
                statsCards.forEach(card => {
                    card.style.flexDirection = 'row';
                    card.style.textAlign = 'left';
                    card.style.padding = '1.5rem';
                });
            }
        }
        
        // Initial call
        updateLayout();
        
        // Update on resize
        window.addEventListener('resize', updateLayout);
        
        // Handle notification icon click
        const notificationIcon = document.querySelector('.notification-icon');
        if (notificationIcon) {
            notificationIcon.addEventListener('click', function(e) {
                e.preventDefault();
                alert('Notifications feature is coming soon!');
            });
        }
        
        // Handle search bar (if exists)
        const searchForm = document.querySelector('.search-form');
        const searchInput = document.querySelector('.search-input');
        
        if (searchForm && searchInput) {
            searchForm.addEventListener('submit', function(e) {
                if (!searchInput.value.trim()) {
                    e.preventDefault();
                    searchInput.focus();
                }
            });
        }
    });
</script>
{% endblock %}