{% extends 'inventory/base.html' %}
{% load static %}

{% block title %}Stock In - Inventory{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'inventory/css/forms.css' %}">
<style>
    /* Stock in form specific styles */
    .container { 
        max-width: 800px; 
        margin: 0 auto; 
    }
    
    h1 { 
        color: #2c3e50; 
        margin-bottom: 30px; 
        padding-bottom: 10px; 
        border-bottom: 3px solid #27ae60; 
    }
    
    /* Form card */
    .form-card { 
        background: white; 
        padding: 30px; 
        border-radius: 8px; 
        box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
        margin-bottom: 30px;
    }
    
    /* Help text */
    .help-text { 
        font-size: 0.9em; 
        color: #666; 
        margin-top: 5px; 
        display: block;
    }
    
    /* Form row */
    .form-row { 
        display: flex; 
        gap: 15px; 
    }
    
    .form-row .form-group { 
        flex: 1; 
    }
    
    /* Required field */
    .required::after {
        content: " *";
        color: #e74c3c;
    }
    
    /* Errors */
    .error { 
        color: #e74c3c; 
        font-size: 0.9em; 
        margin-top: 5px; 
    }
    
    .errorlist { 
        list-style: none; 
        padding: 0; 
        margin: 5px 0; 
        color: #e74c3c; 
        font-size: 0.9em;
    }
    
    /* Actions */
    .actions { 
        display: flex; 
        gap: 10px; 
        margin-top: 30px; 
    }
    
    /* Back link */
    .back-link { 
        display: inline-block; 
        margin-top: 20px; 
        color: #3498db; 
        text-decoration: none; 
        font-weight: 500;
    }
    
    .back-link:hover { 
        text-decoration: underline; 
    }
    
    /* Item info box */
    .item-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        margin-top: 10px;
        border-left: 4px solid #3498db;
    }
    
    .item-info p {
        margin: 5px 0;
        font-size: 0.9em;
    }
    
    /* Alert messages */
    .alert { 
        padding: 15px; 
        border-radius: 8px; 
        margin-bottom: 20px;
        border-left: 4px solid #f39c12;
    }
    
    .alert-success { 
        background: #d4edda; 
        color: #155724; 
        border-left-color: #28a745;
    }
    
    .alert-danger { 
        background: #f8d7da; 
        color: #721c24; 
        border-left-color: #dc3545;
    }
    
    .alert-warning { 
        background: #fff3cd; 
        color: #856404; 
        border-left-color: #ffc107;
    }
    
    /* Form validation indicators */
    .valid { 
        border-color: #27ae60 !important; 
    }
    
    .invalid { 
        border-color: #e74c3c !important; 
    }
    
    /* Mobile responsive */
    @media (max-width: 768px) {
        .form-row {
            flex-direction: column;
            gap: 0;
        }
        
        .actions {
            flex-direction: column;
        }
        
        .actions .btn {
            width: 100%;
            text-align: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<h1>üì• Stock In Entry</h1>

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<div class="form-card">
    <form method="POST" id="stockInForm">
        {% csrf_token %}
        
        <!-- Item Selection -->
        <div class="form-group">
            <label for="id_item" class="required">Item</label>
            {{ form.item }}
            <div class="help-text">Select the item being stocked in</div>
            {% if form.item.errors %}
            <div class="error">{{ form.item.errors }}</div>
            {% endif %}
            
            <!-- Item info will be displayed here -->
            <div id="itemInfo" class="item-info" style="display: none;">
                <p><strong>Current Stock:</strong> <span id="currentStock">0</span> <span id="stockUnit">units</span></p>
                <p><strong>Unit of Measure:</strong> <span id="itemUnit">-</span></p>
                <p><strong>Status:</strong> <span id="itemStatus">-</span></p>
            </div>
        </div>
        
        <!-- Quantity -->
        <div class="form-group">
            <label for="id_quantity" class="required">Quantity</label>
            {{ form.quantity }}
            <div class="help-text">Enter the quantity received (e.g., 20.500 for 20.5kg)</div>
            {% if form.quantity.errors %}
            <div class="error">{{ form.quantity.errors }}</div>
            {% endif %}
        </div>
        
        <!-- Source and Supplier -->
        <div class="form-row">
            <div class="form-group">
                <label for="id_source" class="required">Source</label>
                {{ form.source }}
                <div class="help-text">Where is this stock coming from?</div>
                {% if form.source.errors %}
                <div class="error">{{ form.source.errors }}</div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="id_supplier">Supplier</label>
                {{ form.supplier }}
                <div class="help-text" id="supplierHelp">Optional for non-purchase stock</div>
                {% if form.supplier.errors %}
                <div class="error">{{ form.supplier.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Reference and Notes -->
        <div class="form-group">
            <label for="id_reference">Reference</label>
            {{ form.reference }}
            <div class="help-text">PO Number, GRN, Invoice, etc.</div>
            {% if form.reference.errors %}
            <div class="error">{{ form.reference.errors }}</div>
            {% endif %}
        </div>
        
        <div class="form-group">
            <label for="id_notes">Notes</label>
            {{ form.notes }}
            <div class="help-text">Additional information about this stock in</div>
            {% if form.notes.errors %}
            <div class="error">{{ form.notes.errors }}</div>
            {% endif %}
        </div>
        
        <!-- Hidden field for item ID from URL -->
        {% if request.GET.item %}
        <input type="hidden" name="initial_item" value="{{ request.GET.item }}">
        {% endif %}
        
        <div class="actions">
            <button type="submit" class="btn btn-success" id="submitBtn">
                <span id="submitText">Record Stock In</span>
                <span id="loadingText" style="display: none;">Processing...</span>
            </button>
            <a href="{% url 'inventory:stock_in_list' %}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<a href="{% url 'inventory:dashboard' %}" class="back-link">‚Üê Back to Inventory Dashboard</a>
{% endblock %}

{% block extra_js %}
<script>
    // Form elements
    const itemSelect = document.getElementById('id_item');
    const quantityInput = document.getElementById('id_quantity');
    const sourceSelect = document.getElementById('id_source');
    const supplierInput = document.getElementById('id_supplier');
    const supplierHelp = document.getElementById('supplierHelp');
    const itemInfo = document.getElementById('itemInfo');
    
    // Auto-focus on quantity field if item is pre-selected
    if (quantityInput) {
        quantityInput.focus();
        quantityInput.step = '0.001';
        quantityInput.min = '0.001';
    }
    
    // Show/hide supplier field based on source
    function toggleSupplierField() {
        if (sourceSelect.value === 'Purchase') {
            supplierInput.required = true;
            supplierHelp.textContent = 'Required for purchase stock';
            supplierHelp.style.color = '#e74c3c';
        } else {
            supplierInput.required = false;
            supplierHelp.textContent = 'Optional for non-purchase stock';
            supplierHelp.style.color = '#666';
        }
    }
    
    sourceSelect.addEventListener('change', toggleSupplierField);
    toggleSupplierField(); // Initial check
    
    // Fetch item details when item is selected
    if (itemSelect) {
        itemSelect.addEventListener('change', function() {
            const itemId = this.value;
            if (itemId) {
                fetch(`/inventory/api/item/${itemId}/`)  // You need to create this endpoint
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('currentStock').textContent = data.quantity.toFixed(3);
                            document.getElementById('stockUnit').textContent = data.unit_of_measure;
                            document.getElementById('itemUnit').textContent = data.unit_of_measure;
                            
                            // Determine status
                            let status = 'Good';
                            let statusColor = '#28a745';
                            
                            if (data.quantity <= data.minimum_stock) {
                                status = 'Critical';
                                statusColor = '#dc3545';
                            } else if (data.quantity <= data.reorder_level) {
                                status = 'Low';
                                statusColor = '#ffc107';
                            }
                            
                            document.getElementById('itemStatus').textContent = status;
                            document.getElementById('itemStatus').style.color = statusColor;
                            itemInfo.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching item details:', error);
                    });
            } else {
                itemInfo.style.display = 'none';
            }
        });
        
        // Trigger change event if item is pre-selected from URL
        const urlParams = new URLSearchParams(window.location.search);
        const initialItem = urlParams.get('item');
        if (initialItem && itemSelect.querySelector(`option[value="${initialItem}"]`)) {
            itemSelect.value = initialItem;
            itemSelect.dispatchEvent(new Event('change'));
        }
    }
    
    // Form validation
    const form = document.getElementById('stockInForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            // Validate quantity
            if (quantityInput && parseFloat(quantityInput.value) <= 0) {
                e.preventDefault();
                alert('Please enter a valid quantity greater than 0.');
                quantityInput.focus();
                return false;
            }
            
            // Validate supplier for purchase
            if (sourceSelect.value === 'Purchase' && !supplierInput.value.trim()) {
                e.preventDefault();
                alert('Supplier is required for Purchase stock.');
                supplierInput.focus();
                return false;
            }
            
            // Show loading state
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const loadingText = document.getElementById('loadingText');
            
            if (submitBtn) {
                submitText.style.display = 'none';
                loadingText.style.display = 'inline';
                submitBtn.disabled = true;
            }
            
            return true;
        });
    }
    
    // Real-time validation
    if (quantityInput) {
        quantityInput.addEventListener('input', function() {
            const value = parseFloat(this.value);
            if (isNaN(value) || value <= 0) {
                this.classList.add('invalid');
                this.classList.remove('valid');
            } else {
                this.classList.add('valid');
                this.classList.remove('invalid');
            }
        });
    }
    
    if (supplierInput) {
        supplierInput.addEventListener('input', function() {
            if (sourceSelect.value === 'Purchase' && this.value.trim() === '') {
                this.classList.add('invalid');
                this.classList.remove('valid');
            } else {
                this.classList.add('valid');
                this.classList.remove('invalid');
            }
        });
    }
    
    // Add error styling to form fields with errors
    document.addEventListener('DOMContentLoaded', function() {
        const formFields = form.querySelectorAll('input, select, textarea');
        formFields.forEach(field => {
            if (field.parentElement.querySelector('.error')) {
                field.classList.add('error');
            }
        });
    });
</script>
{% endblock %}